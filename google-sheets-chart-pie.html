<link rel="import" href="flot-pie.html">
<link rel="import" href="../gk-ext/gk-google-sheets.html">

<element name='google-sheets-chart-pie'>

  <template>
    <div id="{{id}}">
      <div id="{{id}}_chartpie" class='{{class}}' style='{{style}}' width='{{width}}' height='{{height}}' radius='{{radius}}' labelRadius='{{labelRadius}}' showLegend='{{showLegend}}' is='flot-pie'>
        <content></content>
      </div>
      <gk-google-sheets id="{{id}}_sheet" key="{{key}}" headers="{{headers}}" gid="{{gid}}" range="{{range}}" query="{{query}}"></gk-google-sheets>
    </div>
  </template>

  <script>
  function getPageId($ele) {
    return '#' + $ele.closest('[data-role="page"]').attr('id');
  }

  function convertSheetData(table) {
    var cellVal = function(cell) {
      return cell ? ('f' in cell ? cell.f : cell.v) : "";
    };
    return $.map(table.rows, function(row) {
      var c1 = row.c[0],
        o = {
          label: cellVal(c1),
          data: [
            []
          ]
        };
      row.c.forEach(function(cell, idx) {
        o.data[0].push(cellVal(cell));
      });
      return o;
    });
  }

  registerElement('google-sheets-chart-pie', {

    $sheet: null,

    init: function() {
      var self = this,
        $ele = self.$ele,
        doInit = function() {
          var $chartpie = $ele.find('#' + self.id + '_chartpie'),
            $sheet = $ele.find('#' + self.id + '_sheet');
          $sheet.on('data', function(e, table) {
            $chartpie.gk('render', convertSheetData(table));
          });
          self.$sheet = $sheet;
          self.refresh();
        };
      if ($.mobile) {
        $(document).on('pageinit', getPageId($ele), doInit);
      } else {
        doInit();
      }
    },

    refresh: function() {
      this.$sheet.gk('refresh');
    }

  });
  </script>

</element>
